<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      
      <!-- Profile Header -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-body text-center p-4">
          <div class="position-relative d-inline-block mb-3">
            <img [src]="profileImage" 
                 alt="Profile Picture" 
                 class="rounded-circle profile-image shadow-sm"
                 style="width: 120px; height: 120px; object-fit: cover;">
            
            @if (isEditing) {
              <div class="position-absolute bottom-0 end-0">
                <button type="button" 
                        class="btn btn-primary btn-sm rounded-circle p-2"
                        onclick="document.getElementById('profileImageInput').click()">
                  <i class="bi bi-camera-fill"></i>
                </button>
              </div>
              
              <input type="file" 
                     id="profileImageInput" 
                     accept="image/*" 
                     style="display: none;" 
                     (change)="onFileSelected($event)">
            }
          </div>
          
          <h3 class="mb-1">{{ user?.name || 'User' }}</h3>
          <p class="text-muted mb-3">{{ user?.email }}</p>
          
          @if (user?.bio) {
            <p class="text-secondary">{{ user.bio }}</p>
          }
          
          <div class="d-flex justify-content-center gap-2">
            @if (!isEditing) {
              <button class="btn btn-primary" (click)="toggleEdit()">
                <i class="bi bi-pencil-square me-2"></i>Edit Profile
              </button>
            } @else {
              <button class="btn btn-success" (click)="onProfileSubmit()" [disabled]="profileForm.invalid || isLoading">
                @if (isLoading) {
                  <span class="spinner-border spinner-border-sm me-2"></span>
                }
                <i class="bi bi-check-lg me-2"></i>Save Changes
              </button>
              <button class="btn btn-secondary" (click)="toggleEdit()">
                <i class="bi bi-x-lg me-2"></i>Cancel
              </button>
            }
          </div>
        </div>
      </div>

      <!-- Messages -->
      @if (successMessage) {
        <div class="alert alert-success d-flex align-items-center mb-4">
          <i class="bi bi-check-circle-fill me-2"></i>
          {{ successMessage }}
        </div>
      }

      @if (errorMessage) {
        <div class="alert alert-danger d-flex align-items-center mb-4">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          {{ errorMessage }}
        </div>
      }

      <!-- Profile Information -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0">
            <i class="bi bi-person-lines-fill me-2"></i>Profile Information
          </h5>
        </div>
        <div class="card-body p-4">
          
          <form [formGroup]="profileForm" (ngSubmit)="onProfileSubmit()">
            <div class="row">
              
              <!-- Name -->
              <div class="col-md-6 mb-3">
                <label for="name" class="form-label">Full Name</label>
                <input type="text" 
                       id="name" 
                       class="form-control" 
                       formControlName="name"
                       [readonly]="!isEditing"
                       [ngClass]="{'is-invalid': profileForm.get('name')?.invalid && profileForm.get('name')?.touched}">
                <div class="invalid-feedback" *ngIf="profileForm.get('name')?.invalid && profileForm.get('name')?.touched">
                  <div *ngIf="profileForm.get('name')?.errors?.['required']">Name is required.</div>
                  <div *ngIf="profileForm.get('name')?.errors?.['minlength']">Name must be at least 2 characters.</div>
                </div>
              </div>

              <!-- Email -->
              <div class="col-md-6 mb-3">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" 
                       id="email" 
                       class="form-control" 
                       formControlName="email"
                       [readonly]="!isEditing"
                       [ngClass]="{'is-invalid': profileForm.get('email')?.invalid && profileForm.get('email')?.touched}">
                <div class="invalid-feedback" *ngIf="profileForm.get('email')?.invalid && profileForm.get('email')?.touched">
                  <div *ngIf="profileForm.get('email')?.errors?.['required']">Email is required.</div>
                  <div *ngIf="profileForm.get('email')?.errors?.['email']">Please enter a valid email.</div>
                </div>
              </div>

              <!-- Phone -->
              <div class="col-md-6 mb-3">
                <label for="phone" class="form-label">Phone Number</label>
                <input type="tel" 
                       id="phone" 
                       class="form-control" 
                       formControlName="phone"
                       [readonly]="!isEditing"
                       placeholder="+1234567890"
                       [ngClass]="{'is-invalid': profileForm.get('phone')?.invalid && profileForm.get('phone')?.touched}">
                <div class="invalid-feedback" *ngIf="profileForm.get('phone')?.invalid && profileForm.get('phone')?.touched">
                  Please enter a valid phone number.
                </div>
              </div>

              <!-- Date of Birth -->
              <div class="col-md-6 mb-3">
                <label for="dateOfBirth" class="form-label">Date of Birth</label>
                <input type="date" 
                       id="dateOfBirth" 
                       class="form-control" 
                       formControlName="dateOfBirth"
                       [readonly]="!isEditing">
              </div>

              <!-- Address -->
              <div class="col-12 mb-3">
                <label for="address" class="form-label">Address</label>
                <input type="text" 
                       id="address" 
                       class="form-control" 
                       formControlName="address"
                       [readonly]="!isEditing"
                       placeholder="Enter your address">
              </div>

              <!-- Bio -->
              <div class="col-12 mb-3">
                <label for="bio" class="form-label">Bio</label>
                <textarea id="bio" 
                          class="form-control" 
                          rows="3" 
                          formControlName="bio"
                          [readonly]="!isEditing"
                          placeholder="Tell us about yourself..."
                          [ngClass]="{'is-invalid': profileForm.get('bio')?.invalid && profileForm.get('bio')?.touched}">
                </textarea>
                <div class="form-text">{{ profileForm.get('bio')?.value?.length || 0 }}/500 characters</div>
                <div class="invalid-feedback" *ngIf="profileForm.get('bio')?.invalid && profileForm.get('bio')?.touched">
                  Bio must be less than 500 characters.
                </div>
              </div>

            </div>

            <!-- Image Controls (only show when editing) -->
            @if (isEditing && profileImage !== 'https://via.placeholder.com/150?text=User') {
              <div class="mt-3">
                <button type="button" class="btn btn-outline-danger btn-sm" (click)="removeProfileImage()">
                  <i class="bi bi-trash me-2"></i>Remove Profile Image
                </button>
              </div>
            }

          </form>
        </div>
      </div>

      <!-- Security Settings -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0">
            <i class="bi bi-shield-lock me-2"></i>Security Settings
          </h5>
        </div>
        <div class="card-body p-4">
          
          @if (!isChangingPassword) {
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">Password</h6>
                <small class="text-muted">Last updated: {{ user?.createdAt | date:'mediumDate' }}</small>
              </div>
              <button class="btn btn-outline-primary" (click)="togglePasswordChange()">
                <i class="bi bi-key me-2"></i>Change Password
              </button>
            </div>
          } @else {
            <form [formGroup]="passwordForm" (ngSubmit)="onPasswordSubmit()">
              
              <!-- Current Password -->
              <div class="mb-3">
                <label for="currentPassword" class="form-label">Current Password</label>
                <input type="password" 
                       id="currentPassword" 
                       class="form-control" 
                       formControlName="currentPassword"
                       [ngClass]="{'is-invalid': passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched}">
                <div class="invalid-feedback" *ngIf="passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched">
                  Current password is required.
                </div>
              </div>

              <!-- New Password -->
              <div class="mb-3">
                <label for="newPassword" class="form-label">New Password</label>
                <input type="password" 
                       id="newPassword" 
                       class="form-control" 
                       formControlName="newPassword"
                       [ngClass]="{'is-invalid': passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched}">
                <div class="form-text">At least 8 characters</div>
                <div class="invalid-feedback" *ngIf="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched">
                  <div *ngIf="passwordForm.get('newPassword')?.errors?.['required']">New password is required.</div>
                  <div *ngIf="passwordForm.get('newPassword')?.errors?.['minlength']">Password must be at least 8 characters.</div>
                </div>
              </div>

              <!-- Confirm Password -->
              <div class="mb-4">
                <label for="confirmPassword" class="form-label">Confirm New Password</label>
                <input type="password" 
                       id="confirmPassword" 
                       class="form-control" 
                       formControlName="confirmPassword"
                       [ngClass]="{'is-invalid': passwordForm.errors?.['mismatch'] && passwordForm.get('confirmPassword')?.touched}">
                <div class="invalid-feedback" *ngIf="passwordForm.errors?.['mismatch'] && passwordForm.get('confirmPassword')?.touched">
                  Passwords do not match.
                </div>
              </div>

              <!-- Password Form Buttons -->
              <div class="d-flex gap-2">
                <button type="submit" 
                        class="btn btn-success" 
                        [disabled]="passwordForm.invalid || isLoading">
                  @if (isLoading) {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                  }
                  <i class="bi bi-check-lg me-2"></i>Update Password
                </button>
                <button type="button" class="btn btn-secondary" (click)="togglePasswordChange()">
                  <i class="bi bi-x-lg me-2"></i>Cancel
                </button>
              </div>
            </form>
          }
        </div>
      </div>

      <!-- Account Actions -->
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0 text-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>Danger Zone
          </h5>
        </div>
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1 text-danger">Delete Account</h6>
              <small class="text-muted">Permanently remove your account and all data.</small>
            </div>
            <button class="btn btn-outline-danger" (click)="deleteAccount()">
              <i class="bi bi-trash me-2"></i>Delete Account
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>